version: 2.1

jobs:
  test:
    docker:
      - image: cimg/ruby:3.4.1
        environment:
          RAILS_ENV: test
          MYSQL_PASSWORD: pdf_accessibility_api
          REGISTRY_HOST: harbor.k8s.libraries.psu.edu
          REGISTRY_REPO: library/psulib_blacklight
          GITHUB_USER: 'psu-stewardship-bot'
          CONFIG_REPO: git@github.com:psu-libraries/pdf_accessibility_api.git
    steps:
      - checkout
      - setup_remote_docker:
          version: docker24
          docker_layer_caching: true
      - run:
          name: Install dependencies
          command: |
            gem install bundler -v "$(grep -A 1 'BUNDLED WITH' Gemfile.lock | tail -n 1 | xargs)"
            bundle _$(grep -A 1 'BUNDLED WITH' Gemfile.lock | tail -n 1 | xargs)_ install
      - run:
          name: Debug check working dir
          command: ls -la $PWD
      - run:
          name: Build and run containers
          command: docker-compose up -d --build 
      # - run:
      #     name: "Lint"
      #     command: docker-compose exec -T web bundle exec niftany
      - run:
          name: "RSpec"
          command: docker-compose exec -T web bundle exec rspec

workflows:
  version: 2
  test:
    jobs:
      - test
